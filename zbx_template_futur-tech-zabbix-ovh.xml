<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <date>2022-12-14T14:24:19Z</date>
    <groups>
        <group>
            <name>Templates/Futur-Tech/Web</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>Template Futur-Tech OVH API</template>
            <name>Template Futur-Tech OVH API</name>
            <description>https://github.com/Futur-Tech/futur-tech-zabbix-ovh</description>
            <groups>
                <group>
                    <name>Templates/Futur-Tech/Web</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>API Keys</name>
                </application>
            </applications>
            <discovery_rules>
                <discovery_rule>
                    <name>Domain discovery</name>
                    <type>EXTERNAL</type>
                    <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/domain/zone&quot;]</key>
                    <delay>10h</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>{#DOMAIN} zone DNS last update</name>
                            <type>EXTERNAL</type>
                            <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/domain/zone/{#DOMAIN}&quot;]</key>
                            <delay>30m</delay>
                            <units>unixtime</units>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Domain {#DOMAIN} DNS</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.lastUpdate</params>
                                </step>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <params>return Date.parse(value)</params>
                                </step>
                                <step>
                                    <type>MULTIPLIER</type>
                                    <params>0.001</params>
                                </step>
                            </preprocessing>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{now()}-{last()}&lt;{$OVH_DNS_CHANGED_WARN}</expression>
                                    <name>{#DOMAIN} zone DNS has been updated in the last {$OVH_DNS_CHANGED_WARN}</name>
                                    <opdata>Update date: {ITEM.LASTVALUE1}</opdata>
                                    <url>https://www.ovh.com/manager/web/#/domain/{#DOMAIN}/information</url>
                                    <priority>WARNING</priority>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                    </item_prototypes>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#DOMAIN}</lld_macro>
                            <path>$.discovery</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                    <preprocessing>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>//Convert array into a discovery-ready JSON object
// https://www.zabbix.com/forum/zabbix-help/419391-utilizing-jsonpath-to-setup-an-lld-macros
var array = JSON.parse(value)
var len = array.length;
var x = 0
output = &quot;{ \&quot;data\&quot; :[&quot;
for (; x &lt; len - 1; x++){
output += &quot;{\&quot;discovery\&quot;: \&quot;&quot; + array[x] + &quot;\&quot;},&quot;
}
output += &quot;{\&quot;discovery\&quot;: \&quot;&quot; + array[x] + &quot;\&quot;}&quot;
output += &quot;]}&quot;
return output</params>
                        </step>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                        </step>
                    </preprocessing>
                </discovery_rule>
                <discovery_rule>
                    <name>Email discovery</name>
                    <type>EXTERNAL</type>
                    <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/email/domain&quot;,&quot;/email/domain/#loop#/account&quot;]</key>
                    <delay>10h</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>{#ACCOUNT}@{#DOMAIN} is blocked</name>
                            <type>DEPENDENT</type>
                            <key>email.domain.account.isblocked[{#DOMAIN},{#ACCOUNT}]</key>
                            <delay>0</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Domain {#DOMAIN} Emails</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.isBlocked</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/email/domain/{#DOMAIN}/account/{#ACCOUNT}/&quot;]</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{last()}&lt;&gt;&quot;false&quot;&#13;
and {$OVH_EMAIL_IGNORE:&quot;{#DOMAIN},{#ACCOUNT}&quot;}=0</expression>
                                    <name>{#ACCOUNT}@{#DOMAIN} account is blocked</name>
                                    <url>https://www.ovh.com/manager/web/#/email_domain/{#DOMAIN}/email</url>
                                    <priority>HIGH</priority>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>{#ACCOUNT}@{#DOMAIN} space available</name>
                            <type>DEPENDENT</type>
                            <key>email.domain.account.size[{#DOMAIN},{#ACCOUNT}]</key>
                            <delay>0</delay>
                            <units>bytes</units>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Domain {#DOMAIN} Emails</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.size</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/email/domain/{#DOMAIN}/account/{#ACCOUNT}/&quot;]</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>{#ACCOUNT}@{#DOMAIN} email count</name>
                            <type>DEPENDENT</type>
                            <key>email.domain.usage.count[{#DOMAIN},{#ACCOUNT}]</key>
                            <delay>0</delay>
                            <units>email(s)</units>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Domain {#DOMAIN} Emails</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.emailCount</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/email/domain/{#DOMAIN}/account/{#ACCOUNT}/usage&quot;]</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{last()}&lt;&gt;0 and {min(#3)}&lt;&gt;0 and {$OVH_EMAIL_FETCHMAIL:&quot;{#DOMAIN},{#ACCOUNT}&quot;}=1 and {$OVH_EMAIL_IGNORE:&quot;{#DOMAIN},{#ACCOUNT}&quot;}=0</expression>
                                    <name>{#ACCOUNT}@{#DOMAIN} account has mail not fetched</name>
                                    <opdata>{ITEM.LASTVALUE1} found</opdata>
                                    <url>https://www.ovh.com/manager/web/#/email_domain/{#DOMAIN}/email</url>
                                    <priority>HIGH</priority>
                                    <description>This email account has the macro OVH_EMAIL_FETCHMAIL set to 1. This means that this OVH email account should be kept empty automatically by Fetchmail.</description>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>{#ACCOUNT}@{#DOMAIN} space used</name>
                            <type>DEPENDENT</type>
                            <key>email.domain.usage.size[{#DOMAIN},{#ACCOUNT}]</key>
                            <delay>0</delay>
                            <units>bytes</units>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Domain {#DOMAIN} Emails</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.quota</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/email/domain/{#DOMAIN}/account/{#ACCOUNT}/usage&quot;]</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>{#ACCOUNT}@{#DOMAIN} details</name>
                            <type>EXTERNAL</type>
                            <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/email/domain/{#DOMAIN}/account/{#ACCOUNT}/&quot;]</key>
                            <delay>30m</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Domain {#DOMAIN} Emails</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                        <item_prototype>
                            <name>{#ACCOUNT}@{#DOMAIN} usage</name>
                            <type>EXTERNAL</type>
                            <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/email/domain/{#DOMAIN}/account/{#ACCOUNT}/usage&quot;]</key>
                            <delay>30m</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Domain {#DOMAIN} Emails</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                        <item_prototype>
                            <name>{#ACCOUNT}@{#DOMAIN} space update quota request</name>
                            <type>EXTERNAL</type>
                            <key>ovh-api-post.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/email/domain/{#DOMAIN}/account/{#ACCOUNT}/updateUsage&quot;]</key>
                            <delay>1h</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Domain {#DOMAIN} Emails</name>
                                </application_prototype>
                            </application_prototypes>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{last()}&lt;&gt;&quot;null&quot;</expression>
                                    <name>{#ACCOUNT}@{#DOMAIN} account space update request failed</name>
                                    <opdata>Latest update request output: {ITEM.LASTVALUE1}</opdata>
                                    <url>https://www.ovh.com/manager/web/#/email_domain/{#DOMAIN}/email</url>
                                    <priority>WARNING</priority>
                                    <description>The returned value should be &quot;null&quot;</description>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                    </item_prototypes>
                    <trigger_prototypes>
                        <trigger_prototype>
                            <expression>({Template Futur-Tech OVH API:email.domain.usage.size[{#DOMAIN},{#ACCOUNT}].last()}/{Template Futur-Tech OVH API:email.domain.account.size[{#DOMAIN},{#ACCOUNT}].last()})*100&gt;95&#13;
and {$OVH_EMAIL_IGNORE:&quot;{#DOMAIN},{#ACCOUNT}&quot;}=0</expression>
                            <name>{#ACCOUNT}@{#DOMAIN} account is almost full</name>
                            <opdata>Used: {ITEM.LASTVALUE1} Available: {ITEM.LASTVALUE2}</opdata>
                            <priority>AVERAGE</priority>
                            <dependencies>
                                <dependency>
                                    <name>{#ACCOUNT}@{#DOMAIN} account is full</name>
                                    <expression>({Template Futur-Tech OVH API:email.domain.usage.size[{#DOMAIN},{#ACCOUNT}].last()}/{Template Futur-Tech OVH API:email.domain.account.size[{#DOMAIN},{#ACCOUNT}].last()})*100&gt;99&#13;
and {$OVH_EMAIL_IGNORE:&quot;{#DOMAIN},{#ACCOUNT}&quot;}=0</expression>
                                </dependency>
                            </dependencies>
                        </trigger_prototype>
                        <trigger_prototype>
                            <expression>({Template Futur-Tech OVH API:email.domain.usage.size[{#DOMAIN},{#ACCOUNT}].last()}/{Template Futur-Tech OVH API:email.domain.account.size[{#DOMAIN},{#ACCOUNT}].last()})*100&gt;99&#13;
and {$OVH_EMAIL_IGNORE:&quot;{#DOMAIN},{#ACCOUNT}&quot;}=0</expression>
                            <name>{#ACCOUNT}@{#DOMAIN} account is full</name>
                            <opdata>Used: {ITEM.LASTVALUE1} Available: {ITEM.LASTVALUE2}</opdata>
                            <url>https://www.ovh.com/manager/web/#/email_domain/{#DOMAIN}/email</url>
                            <priority>HIGH</priority>
                        </trigger_prototype>
                    </trigger_prototypes>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#ACCOUNT}</lld_macro>
                            <path>$.loop_result</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#DOMAIN}</lld_macro>
                            <path>$.source_result</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                </discovery_rule>
                <discovery_rule>
                    <name>API application discovery</name>
                    <type>EXTERNAL</type>
                    <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/me/api/application&quot;]</key>
                    <delay>5m</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>API application {#APP_ID} name</name>
                            <type>EXTERNAL</type>
                            <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/me/api/application/{#APP_ID}&quot;]</key>
                            <delay>15m</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>API Keys</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.name</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>2h</params>
                                </step>
                            </preprocessing>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{count(#2)}&lt;2</expression>
                                    <recovery_mode>NONE</recovery_mode>
                                    <name>New OVH API Key discovered</name>
                                    <opdata>Application Name: {ITEM.LASTVALUE1} ApplicationId: {#APP_ID}</opdata>
                                    <url>https://api.ovh.com/console/?#/me/api/application/%7BapplicationId%7D#GET</url>
                                    <priority>HIGH</priority>
                                    <description>An new OVH API application has been registered in the OVH Account. This trigger need to be closed manually.</description>
                                    <manual_close>YES</manual_close>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                    </item_prototypes>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#APP_ID}</lld_macro>
                            <path>$.discovery</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                    <preprocessing>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>//Convert array into a discovery-ready JSON object
// https://www.zabbix.com/forum/zabbix-help/419391-utilizing-jsonpath-to-setup-an-lld-macros
var array = JSON.parse(value)
var len = array.length;
var x = 0
output = &quot;{ \&quot;data\&quot; :[&quot;
for (; x &lt; len - 1; x++){
output += &quot;{\&quot;discovery\&quot;: \&quot;&quot; + array[x] + &quot;\&quot;},&quot;
}
output += &quot;{\&quot;discovery\&quot;: \&quot;&quot; + array[x] + &quot;\&quot;}&quot;
output += &quot;]}&quot;
return output</params>
                        </step>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                        </step>
                    </preprocessing>
                </discovery_rule>
                <discovery_rule>
                    <name>Telephony discovery</name>
                    <type>EXTERNAL</type>
                    <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/telephony&quot;,&quot;/telephony/#loop#/line&quot;]</key>
                    <delay>10h</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>{#ACCOUNT} - {#SERVICE} telephony service description</name>
                            <type>EXTERNAL</type>
                            <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/telephony/{#ACCOUNT}/line/{#SERVICE}&quot;]</key>
                            <delay>20m</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Telephony {#ACCOUNT}</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.description</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                        <item_prototype>
                            <name>{#ACCOUNT} - {#SERVICE} telephony service latest registration</name>
                            <type>EXTERNAL</type>
                            <key>ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/telephony/{#ACCOUNT}/line/{#SERVICE}/lastRegistrations&quot;]</key>
                            <delay>20m</delay>
                            <units>unixtime</units>
                            <application_prototypes>
                                <application_prototype>
                                    <name>Telephony {#ACCOUNT}</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[0].datetime</params>
                                </step>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <params>return Date.parse(value)</params>
                                </step>
                                <step>
                                    <type>MULTIPLIER</type>
                                    <params>0.001</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                    </item_prototypes>
                    <trigger_prototypes>
                        <trigger_prototype>
                            <expression>{Template Futur-Tech OVH API:ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/telephony/{#ACCOUNT}/line/{#SERVICE}&quot;].now()}-{Template Futur-Tech OVH API:ovh-api-get.py[&quot;{$OVH_API_CONF_NAME}&quot;,&quot;/telephony/{#ACCOUNT}/line/{#SERVICE}/lastRegistrations&quot;].last()}&gt;{$OVH_TEL_REGISTRATION_WARN}</expression>
                            <name>{#ACCOUNT} - {#SERVICE} No telephony service registration in the last {$OVH_TEL_REGISTRATION_WARN}</name>
                            <opdata>Service Description: {ITEM.LASTVALUE1} Latest registration date: {ITEM.LASTVALUE2}</opdata>
                            <url>https://www.ovhtelecom.fr/manager/#/telephony/{#ACCOUNT}/line/{#SERVICE}/detailsOffer</url>
                            <priority>HIGH</priority>
                            <description>This can be a false alarm! &#13;
It has been observed that the data from the API and the current OVH console are sometimes not up-to-date concerning the registration date... Use the &quot;Manager v4&quot; from the menu on the left in order to access the old OVH Console to see if data are more up-to-date.&#13;
&#13;
Registration of service is valid for max 1 hour.</description>
                        </trigger_prototype>
                    </trigger_prototypes>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#ACCOUNT}</lld_macro>
                            <path>$.source_result</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#SERVICE}</lld_macro>
                            <path>$.loop_result</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                </discovery_rule>
            </discovery_rules>
            <macros>
                <macro>
                    <macro>{$OVH_API_CONF_NAME}</macro>
                    <value>default_api</value>
                    <description>Name of the conf file which contains the API keys in /usr/local/etc/ (without the.conf)</description>
                </macro>
                <macro>
                    <macro>{$OVH_DNS_CHANGED_WARN}</macro>
                    <value>1d</value>
                    <description>Trigger if DNS zone was updated</description>
                </macro>
                <macro>
                    <macro>{$OVH_EMAIL_FETCHMAIL}</macro>
                    <value>0</value>
                    <description>By default, email accounts are not mailfetched</description>
                </macro>
                <macro>
                    <macro>{$OVH_EMAIL_FETCHMAIL:&quot;domain.tld, user&quot;}</macro>
                    <value>1</value>
                    <description>Exemple of macro to monitor a mailfetched account (should be kept empty)</description>
                </macro>
                <macro>
                    <macro>{$OVH_EMAIL_IGNORE}</macro>
                    <value>0</value>
                    <description>By default, email accounts are monitored</description>
                </macro>
                <macro>
                    <macro>{$OVH_EMAIL_IGNORE:&quot;domain.tld,user&quot;}</macro>
                    <value>1</value>
                    <description>Exemple of macro to ignore trigger for a specific email account.</description>
                </macro>
                <macro>
                    <macro>{$OVH_TEL_REGISTRATION_WARN}</macro>
                    <value>3h</value>
                    <description>Trigger if service is not registered without this time (registration is valid 1 hour)</description>
                </macro>
            </macros>
        </template>
    </templates>
</zabbix_export>
